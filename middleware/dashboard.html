<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wheelson Explorer Â· Live Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Exo+2:wght@300;400;600;700&display=swap"
    rel="stylesheet">
  <style>
    /* â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #070b12;
      --bg2: #0d1421;
      --bg3: #111827;
      --border: rgba(255, 255, 255, .06);
      --glow: #00ffd5;
      --glow-dim: rgba(0, 255, 213, .12);
      --glow-mid: rgba(0, 255, 213, .4);
      --text: #c8d8e8;
      --text-dim: #5a7080;
      --text-bright: #e8f4ff;
      --red: #ef4444;
      --green: #22c55e;
      --yellow: #f59e0b;
      --orange: #f97316;
      --cyan: #06b6d4;
      --violet: #8b5cf6;
      --mono: 'Share Tech Mono', monospace;
      --sans: 'Exo 2', sans-serif;
    }

    html,
    body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--sans);
      font-size: 14px;
      overflow: hidden;
    }

    /* â”€â”€ Scanline overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: repeating-linear-gradient(0deg,
          transparent,
          transparent 2px,
          rgba(0, 0, 0, .12) 2px,
          rgba(0, 0, 0, .12) 4px);
      pointer-events: none;
      z-index: 1000;
    }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .layout {
      display: grid;
      grid-template-columns: 1fr 380px;
      grid-template-rows: auto 1fr auto;
      height: 100vh;
      gap: 0;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 12px 20px;
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
    }

    .logo {
      font-family: var(--mono);
      font-size: 18px;
      color: var(--glow);
      text-shadow: 0 0 16px var(--glow);
      white-space: nowrap;
    }

    .logo span {
      opacity: .5;
    }

    .header-meta {
      display: flex;
      gap: 20px;
      margin-left: auto;
      align-items: center;
    }

    .badge {
      font-family: var(--mono);
      font-size: 11px;
      padding: 3px 10px;
      border-radius: 4px;
      border: 1px solid var(--border);
      color: var(--text-dim);
    }

    #cycle-badge {
      color: var(--glow);
      border-color: var(--glow-mid);
      text-shadow: 0 0 8px var(--glow);
    }

    .conn-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-dim);
      transition: all .3s;
    }

    .conn-dot.live {
      background: var(--green);
      box-shadow: 0 0 8px var(--green);
    }

    /* â”€â”€ Camera Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .camera-panel {
      position: relative;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border-right: 1px solid var(--border);
    }

    #camera-feed {
      width: 100%;
      height: 100%;
      object-fit: contain;
      image-rendering: pixelated;
      filter: brightness(.95) contrast(1.05) saturate(1.1);
    }

    .camera-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      /* Corner brackets */
      background:
        linear-gradient(var(--glow), var(--glow)) top 16px left 16px / 24px 2px no-repeat,
        linear-gradient(var(--glow), var(--glow)) top 16px left 16px / 2px 24px no-repeat,
        linear-gradient(var(--glow), var(--glow)) top 16px right 16px / 24px 2px no-repeat,
        linear-gradient(var(--glow), var(--glow)) top 16px right 16px / 2px 24px no-repeat,
        linear-gradient(var(--glow), var(--glow)) bottom 16px left 16px / 24px 2px no-repeat,
        linear-gradient(var(--glow), var(--glow)) bottom 16px left 16px / 2px 24px no-repeat,
        linear-gradient(var(--glow), var(--glow)) bottom 16px right 16px / 24px 2px no-repeat,
        linear-gradient(var(--glow), var(--glow)) bottom 16px right 16px / 2px 24px no-repeat;
      opacity: .5;
    }

    .camera-label {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-family: var(--mono);
      font-size: 10px;
      color: var(--glow);
      letter-spacing: 3px;
      opacity: .6;
      text-transform: uppercase;
    }

    .no-feed {
      font-family: var(--mono);
      color: var(--text-dim);
      font-size: 12px;
      letter-spacing: 2px;
      text-align: center;
      line-height: 2;
    }

    .no-feed-icon {
      font-size: 40px;
      display: block;
      margin-bottom: 12px;
    }

    /* â”€â”€ Right Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sidebar {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* â”€â”€ Personality Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .personality-card {
      padding: 16px 18px;
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
    }

    .personality-card .label {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text-dim);
      letter-spacing: 2px;
      margin-bottom: 8px;
    }

    .personality-name {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-bright);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .personality-name .emoji {
      font-size: 22px;
    }

    .personality-name .name-text {
      text-shadow: 0 0 20px var(--p-color, var(--glow));
      color: var(--p-color, var(--glow));
    }

    .personality-bias {
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-dim);
      font-style: italic;
    }

    /* â”€â”€ Thought Bubble â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .thought-section {
      padding: 14px 18px;
      background: var(--bg3);
      border-bottom: 1px solid var(--border);
    }

    .thought-section .label {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text-dim);
      letter-spacing: 2px;
      margin-bottom: 10px;
    }

    .thought-bubble {
      position: relative;
      background: var(--bg2);
      border: 1px solid var(--glow-mid);
      border-radius: 8px;
      padding: 12px 14px;
      min-height: 64px;
      box-shadow: 0 0 20px var(--glow-dim);
    }

    #thought-text {
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.7;
      color: var(--text-bright);
      white-space: pre-wrap;
    }

    .thought-cursor {
      display: inline-block;
      width: 7px;
      height: 13px;
      background: var(--glow);
      opacity: 1;
      animation: blink .8s step-end infinite;
      vertical-align: text-bottom;
      margin-left: 2px;
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: 0
      }
    }

    /* â”€â”€ Action / Distance Row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .status-row {
      display: flex;
      gap: 10px;
      padding: 12px 18px;
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
      align-items: center;
    }

    .action-badge {
      font-family: var(--mono);
      font-size: 13px;
      font-weight: 600;
      padding: 6px 16px;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 2px;
      border: 1px solid transparent;
      transition: background .3s, color .3s, border-color .3s, box-shadow .3s;
      white-space: nowrap;
    }

    .action-forward {
      background: rgba(34, 197, 94, .15);
      color: var(--green);
      border-color: var(--green);
      box-shadow: 0 0 12px rgba(34, 197, 94, .3);
    }

    .action-backward {
      background: rgba(249, 115, 22, .15);
      color: var(--orange);
      border-color: var(--orange);
      box-shadow: 0 0 12px rgba(249, 115, 22, .3);
    }

    .action-left,
    .action-right {
      background: rgba(245, 158, 11, .15);
      color: var(--yellow);
      border-color: var(--yellow);
      box-shadow: 0 0 12px rgba(245, 158, 11, .3);
    }

    .action-stop {
      background: rgba(239, 68, 68, .15);
      color: var(--red);
      border-color: var(--red);
      box-shadow: 0 0 12px rgba(239, 68, 68, .3);
    }

    /* Safety flash */
    @keyframes safety-flash {

      0%,
      100% {
        background: rgba(239, 68, 68, .15);
      }

      50% {
        background: rgba(239, 68, 68, .5);
      }
    }

    .safety-active {
      animation: safety-flash .4s ease 3;
    }

    .dist-widget {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .dist-label {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text-dim);
      letter-spacing: 1px;
      display: flex;
      justify-content: space-between;
    }

    #dist-value {
      transition: color .3s;
    }

    .dist-bar-bg {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, .06);
      border-radius: 3px;
      overflow: hidden;
    }

    #dist-bar-fill {
      height: 100%;
      border-radius: 3px;
      background: var(--glow);
      box-shadow: 0 0 6px var(--glow);
      transition: width .4s ease, background .3s;
      width: 100%;
    }

    /* â”€â”€ Event Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .log-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--bg);
    }

    .log-header {
      padding: 10px 18px;
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text-dim);
      letter-spacing: 2px;
      border-bottom: 1px solid var(--border);
      background: var(--bg2);
    }

    #event-log {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }

    #event-log::-webkit-scrollbar {
      width: 4px;
    }

    #event-log::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 2px;
    }

    .log-entry {
      padding: 8px 18px;
      border-bottom: 1px solid rgba(255, 255, 255, .03);
      animation: fadeIn .3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-4px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .log-meta {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text-dim);
      display: flex;
      gap: 8px;
      margin-bottom: 3px;
    }

    .log-action-tag {
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .log-entry.forward .log-action-tag {
      color: var(--green);
    }

    .log-entry.backward .log-action-tag {
      color: var(--orange);
    }

    .log-entry.left,
    .log-entry.right {}

    .log-entry.left .log-action-tag,
    .log-entry.right .log-action-tag {
      color: var(--yellow);
    }

    .log-entry.stop .log-action-tag {
      color: var(--red);
    }

    .log-thought {
      font-size: 12px;
      color: var(--text);
      line-height: 1.5;
      font-style: italic;
    }

    .safety-tag {
      display: inline-block;
      background: rgba(239, 68, 68, .2);
      color: var(--red);
      font-size: 9px;
      padding: 1px 6px;
      border-radius: 3px;
      border: 1px solid var(--red);
      font-family: var(--mono);
      margin-left: 4px;
      letter-spacing: 1px;
    }

    /* â”€â”€ Status Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    footer {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 7px 20px;
      background: var(--bg2);
      border-top: 1px solid var(--border);
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text-dim);
    }

    footer .seg {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    footer .seg span {
      color: var(--text);
    }

    footer .sep {
      flex: 1;
    }

    #hard-stop-count {
      color: var(--red);
    }

    /* â”€â”€ Mute button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #mute-btn {
      font-family: var(--mono);
      font-size: 11px;
      padding: 4px 12px;
      border-radius: 4px;
      border: 1px solid var(--glow-mid);
      background: var(--glow-dim);
      color: var(--glow);
      cursor: pointer;
      transition: all .2s;
      user-select: none;
      letter-spacing: 1px;
    }

    #mute-btn:hover {
      background: rgba(0, 255, 213, .2);
    }

    #mute-btn.muted {
      border-color: var(--text-dim);
      background: transparent;
      color: var(--text-dim);
    }
  </style>
</head>

<body>

  <div class="layout">

    <!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <header>
      <div class="logo">[ WHEELSON <span>//</span> EXPLORER ]</div>
      <div class="header-meta">
        <div class="badge" id="cycle-badge">CYCLE 0</div>
        <div class="badge" id="status-badge">CONNECTINGâ€¦</div>
        <button id="mute-btn" title="Toggle Wheelson voice">ðŸ”Š VOICE</button>
        <div class="conn-dot" id="conn-dot" title="Stream connection"></div>
      </div>
    </header>

    <!-- â”€â”€ Camera â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="camera-panel">
      <img id="camera-feed" src="" alt="" style="display:none">
      <div class="no-feed" id="no-feed">
        <span class="no-feed-icon">ðŸ“¡</span>
        AWAITING FIRST FRAMEâ€¦<br>
        <span style="font-size:10px;opacity:.5">stream will begin shortly</span>
      </div>
      <div class="camera-overlay"></div>
      <div class="camera-label">LIVE Â· ONBOARD CAM</div>
    </div>

    <!-- â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <aside class="sidebar">

      <!-- Personality card -->
      <div class="personality-card">
        <div class="label">ACTIVE PERSONALITY</div>
        <div class="personality-name">
          <span class="emoji" id="p-emoji">ðŸ¤–</span>
          <span class="name-text" id="p-name">â€”</span>
        </div>
        <div class="personality-bias" id="p-bias">â€“</div>
      </div>

      <!-- Thought bubble -->
      <div class="thought-section">
        <div class="label">INTERNAL MONOLOGUE</div>
        <div class="thought-bubble">
          <span id="thought-text">Awaiting first cycleâ€¦</span><span class="thought-cursor"></span>
        </div>
      </div>

      <!-- Action + Distance row -->
      <div class="status-row">
        <div class="action-badge action-stop" id="action-badge">STOP</div>
        <div class="dist-widget">
          <div class="dist-label">
            <span>DISTANCE</span>
            <span id="dist-value">â€” cm</span>
          </div>
          <div class="dist-bar-bg">
            <div id="dist-bar-fill"></div>
          </div>
        </div>
      </div>

      <!-- Event log -->
      <div class="log-section">
        <div class="log-header">EVENT LOG</div>
        <div id="event-log"></div>
      </div>

    </aside>

    <!-- â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <footer>
      <div class="seg">HARD STOPS <span id="hard-stop-count">0</span></div>
      <div class="seg">LAST MOVE <span id="footer-duration">â€”</span></div>
      <div class="sep"></div>
      <div class="seg">WHEELSON EXPLORER Â· 2025</div>
    </footer>

  </div>

  <script>
    // â”€â”€ Personality metadata (mirrors middleware PERSONALITIES dict) â”€â”€
    const PERSONALITIES = {
      benson: {
        name: "BENSON", emoji: "ðŸ¦º", color: "#f59e0b", bias: "Methodical Â· centre-of-path Â· zero-risk tolerance",
        voiceHints: ["Alex", "Daniel", "Fred", "Ralph"]
      },
      sir_david: {
        name: "Sir David", emoji: "ðŸŽ™ï¸", color: "#10b981", bias: "Curiosity-driven Â· moves toward interesting objects",
        voiceHints: ["Daniel", "Arthur", "Oliver", "Rishi"]
      },
      klaus: {
        name: "Klaus", emoji: "ðŸŽ¨", color: "#8b5cf6", bias: "Perimeter-hugging Â· wide arcing turns",
        voiceHints: ["Martha", "Victoria", "Serena", "Moira"]
      },
      zog7: {
        name: "Zog-7", emoji: "ðŸ‘¾", color: "#06b6d4", bias: "Stealthy Â· shadow-seeking Â· wall-hugging",
        voiceHints: ["Zarvox", "Trinoids", "Albert", "Cellos"]
      },
    };

    // â”€â”€ Voice engine â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const synth = window.speechSynthesis;
    let isMuted = false;
    let activeVoice = null;
    let currentPersonalityKey = 'benson';
    let hasUserGesture = false;  // browsers block TTS until first interaction
    let pendingThought = null;  // first thought buffered until gesture

    // Pick the best available voice for a personality
    function pickVoice(key) {
      const hints = (PERSONALITIES[key] || {}).voiceHints || [];
      const voices = synth.getVoices();
      for (const hint of hints) {
        const v = voices.find(v => v.name.toLowerCase().includes(hint.toLowerCase()));
        if (v) return v;
      }
      return voices.find(v => v.lang.startsWith('en')) || voices[0] || null;
    }

    function doSpeak(text) {
      synth.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.voice = activeVoice;
      utter.rate = 1.05;
      utter.pitch = currentPersonalityKey === 'zog7' ? 0.7 : 1.0;
      synth.speak(utter);
    }

    // Speak â€” buffers silently if no user gesture has happened yet
    function speak(text) {
      if (isMuted || !text || !synth) return;
      if (!hasUserGesture) { pendingThought = text; return; }
      doSpeak(text);
    }

    // On first gesture, unlock audio and drain any buffered thought
    function onFirstGesture() {
      if (hasUserGesture) return;
      hasUserGesture = true;
      if (pendingThought && !isMuted) { doSpeak(pendingThought); pendingThought = null; }
    }
    document.addEventListener('click', onFirstGesture);
    document.addEventListener('keydown', onFirstGesture);

    // Voices load async on some browsers
    synth.onvoiceschanged = () => { activeVoice = pickVoice(currentPersonalityKey); };
    activeVoice = pickVoice(currentPersonalityKey);

    // Mute toggle
    const $muteBtn = document.getElementById('mute-btn');
    $muteBtn.addEventListener('click', () => {
      isMuted = !isMuted;
      if (isMuted) { synth.cancel(); $muteBtn.textContent = 'ðŸ”‡ MUTED'; $muteBtn.classList.add('muted'); }
      else { $muteBtn.textContent = 'ðŸ”Š VOICE'; $muteBtn.classList.remove('muted'); }
    });


    // â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const $feed = document.getElementById('camera-feed');
    const $noFeed = document.getElementById('no-feed');
    const $thought = document.getElementById('thought-text');
    const $action = document.getElementById('action-badge');
    const $distVal = document.getElementById('dist-value');
    const $distBar = document.getElementById('dist-bar-fill');
    const $log = document.getElementById('event-log');
    const $cycle = document.getElementById('cycle-badge');
    const $status = document.getElementById('status-badge');
    const $dot = document.getElementById('conn-dot');
    const $pEmoji = document.getElementById('p-emoji');
    const $pName = document.getElementById('p-name');
    const $pBias = document.getElementById('p-bias');
    const $stops = document.getElementById('hard-stop-count');
    const $duration = document.getElementById('footer-duration');

    let hardStopCount = 0;
    let lastThought = '';
    let typewriterTimer = null;

    // â”€â”€ Typewriter effect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function typewrite(text) {
      if (text === lastThought) return;
      lastThought = text;
      clearTimeout(typewriterTimer);
      $thought.textContent = '';
      speak(text);   // ðŸ”Š narrate the new thought
      let i = 0;
      const step = () => {
        if (i < text.length) {
          $thought.textContent += text[i++];
          typewriterTimer = setTimeout(step, 6);
        }
      };
      step();
    }

    // â”€â”€ Update distance bar & value â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateDistance(cm) {
      const MAX_CM = 200;
      const frac = Math.min(cm, MAX_CM) / MAX_CM;
      const pct = Math.round(frac * 100);
      const danger = cm < 10;
      const warn = cm < 30;

      $distVal.textContent = cm >= 900 ? 'âˆž  cm' : `${cm.toFixed(1)} cm`;
      $distVal.style.color = danger ? '#ef4444' : warn ? '#f59e0b' : '#00ffd5';
      $distBar.style.width = `${pct}%`;
      $distBar.style.background = danger ? '#ef4444' : warn ? '#f59e0b' : '#00ffd5';
      $distBar.style.boxShadow = `0 0 6px ${danger ? '#ef4444' : warn ? '#f59e0b' : '#00ffd5'}`;
    }

    // â”€â”€ Update action badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateAction(action, safety) {
      const classes = 'action-badge action-forward action-backward action-left action-right action-stop safety-active';
      $action.className = `action-badge action-${action}`;
      $action.textContent = action.toUpperCase();
      if (safety) {
        $action.classList.add('safety-active');
        hardStopCount++;
        $stops.textContent = hardStopCount;
      }
    }

    // â”€â”€ Update personality panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updatePersonality(key) {
      const p = PERSONALITIES[key] || {};
      $pEmoji.textContent = p.emoji || 'ðŸ¤–';
      $pName.textContent = p.name || key;
      $pName.style.color = p.color || '#00ffd5';
      $pName.style.textShadow = `0 0 20px ${p.color || '#00ffd5'}`;
      $pBias.textContent = p.bias || '';
      document.documentElement.style.setProperty('--p-color', p.color || '#00ffd5');
      // Reselect voice when personality changes
      if (key !== currentPersonalityKey) {
        currentPersonalityKey = key;
        activeVoice = pickVoice(key);
      }
    }

    // â”€â”€ Append event log entry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function appendLog(data) {
      const el = document.createElement('div');
      el.className = `log-entry ${data.action}`;
      el.innerHTML = `
    <div class="log-meta">
      <span>${data.ts || ''}</span>
      <span class="log-action-tag">${data.action.toUpperCase()}${data.duration_ms ? ` Â· ${data.duration_ms}ms` : ''}</span>
      <span>${data.distance_cm < 900 ? data.distance_cm.toFixed(1) + ' cm' : 'âˆž'}</span>
      ${data.safety ? '<span class="safety-tag">âš  HARD STOP</span>' : ''}
    </div>
    <div class="log-thought">"${data.thought || ''}"</div>`;

      $log.prepend(el);

      // Trim old entries
      while ($log.children.length > 20) $log.removeChild($log.lastChild);
    }

    // â”€â”€ Process SSE event â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function handleEvent(data) {
      // Camera feed
      if (data.frame_b64) {
        $feed.src = 'data:image/jpeg;base64,' + data.frame_b64;
        $feed.style.display = 'block';
        $noFeed.style.display = 'none';
      }

      // Personality
      if (data.personality) updatePersonality(data.personality);

      // Thought â€” use != null so an empty string still triggers the update
      if (data.thought != null) typewrite(data.thought || "â€¦");

      // Action badge
      updateAction(data.action || 'stop', !!data.safety);

      // Distance
      updateDistance(parseFloat(data.distance_cm) || 999);

      // Cycle counter
      $cycle.textContent = `CYCLE ${data.cycle || 0}`;

      // Footer
      if (data.duration_ms) $duration.textContent = `${data.duration_ms}ms`;

      // Log
      appendLog(data);
    }

    // â”€â”€ SSE connection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function connect() {
      $status.textContent = 'CONNECTINGâ€¦';
      $dot.classList.remove('live');

      const es = new EventSource('/stream');

      es.onopen = () => {
        $status.textContent = 'LIVE';
        $dot.classList.add('live');
      };

      es.onmessage = (e) => {
        try {
          handleEvent(JSON.parse(e.data));
        } catch (err) {
          console.error('Parse error:', err);
        }
      };

      es.onerror = () => {
        $status.textContent = 'RECONNECTINGâ€¦';
        $dot.classList.remove('live');
        es.close();
        setTimeout(connect, 3000);
      };
    }

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    connect();
  </script>
</body>

</html>